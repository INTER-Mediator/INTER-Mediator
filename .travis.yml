dist: trusty

sudo: false

language:
  - php

os:
  - linux

php:
  - nightly
  - 7.4
  - 7.3
  - 7.2
  - 7.1
  - 7.0
  - 5.6
  - 5.5
  - 5.4

matrix:
  include:
    - php: 5.3
      dist: precise
    - php: 5.2
      dist: precise
  allow_failures:
    - php: nightly

## for Headless Chrome and trusty (Headless Chrome is available on trusty)
addons:
  chrome: stable
  firefox: "latest-esr"
  apt:
    packages:
      - dbus-x11

before_script:
  - export DISPLAY=:99.0
  - sh -e /etc/init.d/xvfb start
  - sleep 5
  - npm install
  - node_modules/.bin/buster-server &
  - sleep 5
  - firefox http://localhost:1111/capture &
  - if [[ $TRAVIS_PHP_VERSION != "5.2" && $TRAVIS_PHP_VERSION != "5.3" ]]; then google-chrome-stable --headless --disable-gpu --remote-debugging-port=9222 http://localhost:1111/capture & fi
  - sleep 5
  - mysql -u root < ./dist-docs/sample_schema_mysql.txt
  - sqlite3 /tmp/sample.sq3 < ./dist-docs/sample_schema_sqlite.txt
  - chmod 666 /tmp/sample.sq3
  - cd INTER-Mediator-UnitTest
  - cat DB_PDO-SQLite_Test.php | sed -e 's/sqlite:\/var\/db\/im\/sample.sq3/sqlite:\/tmp\/sample.sq3/' > DB_PDO-SQLite_Test.tmp; mv DB_PDO-SQLite_Test.tmp DB_PDO-SQLite_Test.php
  - cd ..
  - psql -c 'create database test_db;' -U postgres
  - psql -U postgres -f ./dist-docs/sample_schema_pgsql.txt test_db
  - if [[ ${TRAVIS_PHP_VERSION:0:1} == "5" && $TRAVIS_PHP_VERSION != "5.2" && $TRAVIS_PHP_VERSION != "5.6" ]]; then composer require 'phpunit/phpunit=4.8.x'; composer install; fi
  - if [[ $TRAVIS_PHP_VERSION == "5.6" ]]; then composer require 'phpunit/phpunit=5.7.x'; composer install; fi
  - if [[ $TRAVIS_PHP_VERSION == "7.0" ]]; then composer require 'phpunit/phpunit=6.5.x'; composer install; fi
  - if [[ $TRAVIS_PHP_VERSION == "7.1" ]]; then composer require 'phpunit/phpunit=7.5.x'; composer install; fi
  - if [[ $TRAVIS_PHP_VERSION == "7.2" ]]; then composer require 'phpunit/phpunit=8.5.x'; composer install; fi
  - if [[ $TRAVIS_PHP_VERSION == "7.3" ]]; then composer require 'phpunit/phpunit=8.5.x'; composer install; fi
  - if [[ $TRAVIS_PHP_VERSION == "7.4" || $TRAVIS_PHP_VERSION == "nightly" ]]; then composer require 'phpunit/phpunit=9.2.x'; composer install; fi
  - if [[ ${TRAVIS_PHP_VERSION:0:1} != "5" && $TRAVIS_PHP_VERSION != "7.0" ]]; then find INTER-Mediator-UnitTest/*.php -type f -print0 | xargs -0 sed -i -e "s/function\ setUp()/function\ setUp():\ void/g"; fi
  - if [[ $TRAVIS_PHP_VERSION == "7.4" || $TRAVIS_PHP_VERSION == "nightly" ]]; then find INTER-Mediator-UnitTest/*.php -type f -print0 | xargs -0 sed -i -e "s/assertContains/assertStringContainsStringIgnoringCase/g"; fi
  - if [[ $TRAVIS_PHP_VERSION == "7.4" || $TRAVIS_PHP_VERSION == "nightly" ]]; then find INTER-Mediator-UnitTest/*.php -type f -print0 | xargs -0 sed -i -e "s/assertNotContains/assertStringNotContainsStringIgnoringCase/g"; fi

script:
  - if [[ $TRAVIS_PHP_VERSION == "5.2" ]]; then phpunit --configuration ./INTER-Mediator-UnitTest/phpunit.xml ./INTER-Mediator-UnitTest/INTERMediator_AllTests.php; fi
  - if [[ ${TRAVIS_PHP_VERSION:0:1} == "5" && $TRAVIS_PHP_VERSION != "5.2" ]]; then vendor/bin/phpunit --configuration ./INTER-Mediator-UnitTest/phpunit.xml ./INTER-Mediator-UnitTest/INTERMediator_AllTests.php; fi
  - if [[ ${TRAVIS_PHP_VERSION:0:1} != "5" ]]; then vendor/bin/phpunit --globals-backup --configuration ./INTER-Mediator-UnitTest/phpunit.xml ./INTER-Mediator-UnitTest/INTERMediator_AllTests.php; fi
  - npm test

notifications:
  slack:
    rooms:
      - intermediator:INKkFZQWI94gsq6DYxRnaWeb#product
    on_success: change
    on_failure: always
    on_start: change
  webhooks:
    urls:
      - https://webhooks.gitter.im/e/ab3046b24c1b21df358d
